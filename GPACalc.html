<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة المعدل التراكمي المتقدمة (GPA) مع تحليل مخصص</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8;
            /* Light blue-gray background */
        }

        .container {
            max-width: 768px;
            /* md: max-w-3xl - Reduced from 900px */
            margin: 1.5rem auto;
            /* Reduced margin */
            padding: 1.25rem;
            /* Reduced padding */
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.08), 0 8px 8px -5px rgba(0, 0, 0, 0.03);
            /* Softer shadow */
        }

        .input-field,
        .select-field {
            border-radius: 0.375rem;
            border: 1px solid #cbd5e1;
            padding: 0.5rem 0.75rem;
            /* Reduced padding */
            font-size: 0.875rem;
            /* text-sm */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            width: 100%;
        }

        .input-field:focus,
        .select-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        .btn {
            padding: 0.5rem 1rem;
            /* Reduced padding */
            font-size: 0.875rem;
            /* text-sm */
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-lg {
            /* Specific for main calculate button if needed */
            padding: 0.625rem 1.25rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .section-title {
            font-size: 1.125rem;
            /* text-lg - Reduced from 1.25rem */
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
            padding-bottom: 0.375rem;
            /* Reduced padding */
            border-bottom: 2px solid #3b82f6;
        }

        .semester-block {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.875rem;
            /* Reduced padding */
            margin-bottom: 1rem;
            /* Reduced margin */
        }

        .semester-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.625rem;
            /* Reduced margin */
        }

        .semester-title-input {
            font-weight: 600;
            font-size: 1rem;
            /* text-base */
            border: none;
            background: transparent;
            padding: 0.25rem;
            color: #1f2937;
        }

        .semester-title-input:focus {
            outline: 1px dashed #cbd5e1;
        }


        .course-row {
            display: grid;
            grid-template-columns: 1fr 80px 120px 60px;
            /* Adjusted column widths */
            gap: 0.5rem;
            /* Reduced gap */
            align-items: center;
            padding: 0.625rem 0;
            /* Reduced padding */
            border-bottom: 1px solid #e5e7eb;
        }

        .course-row:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {

            /* Adjusted breakpoint */
            .course-row {
                grid-template-columns: 1fr 1fr;
                /* Two columns for course name/credits and grade/remove */
                gap: 0.75rem;
            }

            .course-row>input[type="text"] {
                grid-column: span 2 / span 2;
            }

            /* Course name spans full width */
            .course-row>input[type="number"],
            .course-row>select,
            .course-row>button {
                /* Elements will naturally flow, or adjust specific widths if needed */
            }
        }

        @media (max-width: 480px) {

            /* Stacking on very small screens */
            .course-row {
                grid-template-columns: 1fr;
            }

            .course-row>* {
                margin-bottom: 0.5rem;
            }

            .course-row>*:last-child {
                margin-bottom: 0;
            }
        }

        .results-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.25rem;
            /* Reduced margin */
        }

        .gpa-value {
            font-size: 1.75rem;
            /* Reduced from 1.875rem */
            font-weight: 700;
            color: #1d4ed8;
        }

        #messageBox {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.875rem 1.25rem;
            /* Reduced padding */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            font-weight: 600;
            max-width: 90%;
            text-align: center;
            font-size: 0.875rem;
        }

        #messageBox.success {
            background-color: #10b981;
            color: white;
        }

        #messageBox.error {
            background-color: #ef4444;
            color: white;
        }

        .copyright {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 1.5rem;
            text-align: center;
        }

        /* Reduced font size and margin */
        .disclaimer {
            font-size: 0.8rem;
            color: #4b5563;
            margin-top: 1rem;
            text-align: center;
            padding: 0.625rem;
            background-color: #fffbeb;
            border: 1px solid #fef3c7;
            border-radius: 0.375rem;
        }

        /* Reduced font size and padding */

        #analysisResultDiv {
            white-space: pre-wrap;
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 0.5rem;
            padding: 0.875rem;
            /* Reduced padding */
            margin-top: 1rem;
            color: #3730a3;
            font-size: 0.875rem;
            /* Reduced font size */
            line-height: 1.6;
        }

        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            /* Thinner border */
            width: 30px;
            /* Smaller spinner */
            height: 30px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
            margin: 0.75rem auto;
            /* Reduced margin */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .start-options label {
            display: block;
            padding: 0.625rem;
            /* Reduced padding */
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .start-options label h3 {
            font-size: 0.95rem;
            /* Reduced font size */
        }

        .start-options label p {
            font-size: 0.8rem;
            /* Reduced font size */
        }

        .start-options input[type="radio"]:checked+label {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        .start-options input[type="radio"] {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">حاسبة المعدل التراكمي (GPA)</h1>
            <p class="text-gray-600 mt-1 text-sm">أضف فصولك الدراسية وموادك لحساب معدلك واحصل على تحليل لأدائك.</p>
        </header>

        <section id="startOptionsSection" class="mb-4 p-3 border border-gray-200 rounded-lg bg-gray-50">
            <h2 class="section-title">كيف تريد البدء؟</h2>
            <div class="start-options grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <input type="radio" id="startFresh" name="startOption" value="fresh" checked>
                    <label for="startFresh">
                        <h3 class="font-semibold text-gray-700">البدء من الصفر</h3>
                        <p class="text-sm text-gray-500">إضافة فصول دراسية جديدة فقط.</p>
                    </label>
                </div>
                <div>
                    <input type="radio" id="startWithPrevious" name="startOption" value="previous">
                    <label for="startWithPrevious">
                        <h3 class="font-semibold text-gray-700">إدخال معدل تراكمي سابق</h3>
                        <p class="text-sm text-gray-500">إدخال معدلك التراكمي وساعاتك المعتمدة السابقة كنقطة بداية.</p>
                    </label>
                </div>
            </div>
        </section>

        <section id="previousGPASection" class="mb-4 p-3 border border-gray-200 rounded-lg bg-gray-50 hidden">
            <h2 class="section-title">المعدل التراكمي السابق</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label for="prevGPAInput" class="block text-xs font-medium text-gray-700 mb-1">المعدل التراكمي
                        السابق:</label> <input type="number" id="prevGPAInput" step="0.001" min="0" max="4"
                        class="input-field" placeholder="مثال: 3.500">
                </div>
                <div>
                    <label for="prevCreditsInput" class="block text-xs font-medium text-gray-700 mb-1">إجمالي الساعات
                        المعتمدة السابقة:</label> <input type="number" id="prevCreditsInput" step="0.1" min="0"
                        class="input-field" placeholder="مثال: 60">
                </div>
            </div>
        </section>

        <div id="semestersContainer">
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-3"> <button id="addSemesterBtn"
                class="btn btn-secondary w-full sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path
                        d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                إضافة فصل دراسي حالي
            </button>
            <button id="calculateOverallGPABtn" class="btn btn-primary btn-lg w-full sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-2" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 7h6m0 10v-3m-3 3h3m-3-10l-3 3m3-3l3 3m0 0l-3 3m3-3l3-3" />
                </svg>
                احسب المعدل التراكمي الكلي
            </button>
        </div>

        <section id="overallResultsSection" class="results-card hidden">
            <h2 class="section-title">النتائج الإجمالية:</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                    <p class="text-gray-600 text-sm">المعدل التراكمي الكلي (Cumulative GPA):</p>
                    <p id="overallCumulativeGPA" class="gpa-value">0.000</p>
                </div>
                <div>
                    <p class="text-gray-600 text-sm">إجمالي الساعات المعتمدة المكتسبة:</p>
                    <p id="overallTotalCredits" class="text-base font-semibold text-gray-800">0</p>
                </div>
            </div>
            <div class="mt-4 text-center"> <button id="getAnalysisBtn" class="btn btn-success">
                    ✨ احصل على تحليل شامل ونصائح
                </button>
            </div>
            <div id="analysisLoadingIndicator" class="hidden mt-3">
                <div class="loading-spinner"></div>
                <p class="text-center text-gray-600 text-sm">جاري تحليل أدائك... يرجى الانتظار.</p>
            </div>
            <div id="analysisResultDiv" class="hidden">
            </div>
        </section>

        <div class="disclaimer mt-6">
            <h3 class="font-semibold mb-1 text-sm">إخلاء مسؤولية:</h3>
            <p>هذه الحاسبة هي أداة تقديرية فقط. قد تختلف طرق حساب المعدل بين المؤسسات التعليمية. يرجى دائمًا الرجوع إلى
                جامعتك أو كليتك للحصول على حسابات المعدل الرسمية والتحقق من صحة النتائج. النصائح المقدمة هي لأغراض
                إرشادية عامة ولا تغني عن الاستشارة الأكاديمية المتخصصة.</p>
        </div>

        <div class="copyright">
            <p>&copy; <span id="currentYear"></span> تطوير بواسطة أحمد يوسف. جميع الحقوق محفوظة.</p>
        </div>
    </div>

    <div id="messageBox"><span id="messageText"></span></div>

    <script>
        const semestersContainer = document.getElementById('semestersContainer');
        const addSemesterBtn = document.getElementById('addSemesterBtn');
        const calculateOverallGPABtn = document.getElementById('calculateOverallGPABtn');
        const overallResultsSection = document.getElementById('overallResultsSection');
        const overallCumulativeGPADisplay = document.getElementById('overallCumulativeGPA');
        const overallTotalCreditsDisplay = document.getElementById('overallTotalCredits');
        const currentYearSpan = document.getElementById('currentYear');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        const getAnalysisBtn = document.getElementById('getAnalysisBtn');
        const analysisLoadingIndicator = document.getElementById('analysisLoadingIndicator');
        const analysisResultDiv = document.getElementById('analysisResultDiv');

        const startOptionsRadios = document.querySelectorAll('input[name="startOption"]');
        const previousGPASection = document.getElementById('previousGPASection');
        const prevGPAInputElement = document.getElementById('prevGPAInput');
        const prevCreditsInputElement = document.getElementById('prevCreditsInput');


        if (currentYearSpan) {
            currentYearSpan.textContent = new Date().getFullYear();
        }

        const gradePoints = {
            'A+': 4.0, 'A': 4.0, 'A-': 3.7,
            'B+': 3.3, 'B': 3.0, 'B-': 2.7,
            'C+': 2.3, 'C': 2.0, 'C-': 1.7,
            'D+': 1.3, 'D': 1.0,
            'F': 0.0
        };
        const gradeOptions = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'F'];

        let semesterCounter = 0;
        let allSemestersDataForAnalysis = [];

        function showAppMessage(message, type = 'error', duration = 4000) {
            messageText.textContent = message;
            messageBox.className = '';
            messageBox.classList.add(type);
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, duration);
        }

        startOptionsRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'previous') {
                    previousGPASection.classList.remove('hidden');
                } else {
                    previousGPASection.classList.add('hidden');
                    prevGPAInputElement.value = '';
                    prevCreditsInputElement.value = '';
                }
                semestersContainer.innerHTML = '';
                semesterCounter = 0;
                addSemester();
                overallResultsSection.classList.add('hidden');
                getAnalysisBtn.classList.add('hidden');
                analysisResultDiv.classList.add('hidden');
                analysisResultDiv.innerHTML = '';
            });
        });


        function createCourseRow(semesterId) {
            const courseRow = document.createElement('div');
            courseRow.classList.add('course-row');

            const courseNameInput = document.createElement('input');
            courseNameInput.type = 'text';
            courseNameInput.placeholder = `اسم المادة (اختياري)`;
            courseNameInput.classList.add('input-field', 'course-name');

            const creditsInput = document.createElement('input');
            creditsInput.type = 'number';
            creditsInput.step = '0.1';
            creditsInput.min = '0';
            creditsInput.placeholder = 'الساعات';
            creditsInput.classList.add('input-field', 'course-credits');
            creditsInput.required = true;

            const gradeSelect = document.createElement('select');
            gradeSelect.classList.add('select-field', 'course-grade');
            gradeSelect.required = true;
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "التقدير"; // Shorter default
            defaultOption.disabled = true;
            defaultOption.selected = true;
            gradeSelect.appendChild(defaultOption);
            gradeOptions.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });

            const removeCourseBtn = document.createElement('button');
            removeCourseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`; // Smaller Icon
            removeCourseBtn.classList.add('btn', 'btn-danger', 'p-1.5', 'text-xs'); // Adjusted padding and size
            removeCourseBtn.type = 'button';
            removeCourseBtn.title = "حذف المادة";
            removeCourseBtn.onclick = () => courseRow.remove();

            courseRow.append(courseNameInput, creditsInput, gradeSelect, removeCourseBtn);
            return courseRow;
        }

        function addSemester() {
            semesterCounter++;
            const semesterId = `semester-${semesterCounter}`;

            const semesterBlock = document.createElement('div');
            semesterBlock.classList.add('semester-block');
            semesterBlock.id = semesterId;

            const semesterHeader = document.createElement('div');
            semesterHeader.classList.add('semester-header');

            const semesterTitleInput = document.createElement('input');
            semesterTitleInput.type = 'text';
            semesterTitleInput.value = `الفصل الدراسي الحالي ${semesterCounter}`;
            semesterTitleInput.classList.add('semester-title-input', 'text-gray-700'); // Removed text-lg
            semesterTitleInput.placeholder = "اسم الفصل (مثال: ربيع 2024)";


            const removeSemesterBtn = document.createElement('button');
            removeSemesterBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg> إزالة الفصل`; // Smaller icon
            removeSemesterBtn.classList.add('btn', 'btn-danger', 'text-xs'); // text-xs
            removeSemesterBtn.type = 'button';
            removeSemesterBtn.onclick = () => semesterBlock.remove();

            semesterHeader.append(semesterTitleInput, removeSemesterBtn);

            const coursesDiv = document.createElement('div');
            coursesDiv.classList.add('courses-list');

            const addCourseBtnSemester = document.createElement('button');
            addCourseBtnSemester.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> إضافة مادة لهذا الفصل`; // Smaller icon
            addCourseBtnSemester.classList.add('btn', 'btn-primary', 'mt-2', 'text-xs'); // text-xs, reduced margin
            addCourseBtnSemester.type = 'button';
            addCourseBtnSemester.onclick = () => coursesDiv.appendChild(createCourseRow(semesterId));

            const semesterResultDiv = document.createElement('div');
            semesterResultDiv.classList.add('mt-2', 'p-1.5', 'bg-blue-50', 'rounded'); // Reduced margin & padding
            semesterResultDiv.innerHTML = `
                <p class="text-xs text-gray-600">معدل هذا الفصل: <span class="font-semibold text-blue-600 semester-gpa-display">N/A</span></p>
                <p class="text-xs text-gray-600">ساعات هذا الفصل: <span class="font-semibold text-blue-600 semester-credits-display">N/A</span></p>
            `;

            semesterBlock.append(semesterHeader, coursesDiv, addCourseBtnSemester, semesterResultDiv);
            semestersContainer.appendChild(semesterBlock);

            coursesDiv.appendChild(createCourseRow(semesterId));
        }

        function calculateOverallGPA() {
            allSemestersDataForAnalysis = [];
            let overallTotalPoints = 0;
            let overallTotalCredits = 0;
            let allSemestersValid = true;

            analysisResultDiv.classList.add('hidden');
            analysisResultDiv.innerHTML = '';
            getAnalysisBtn.classList.add('hidden');


            const startOptionSelected = document.querySelector('input[name="startOption"]:checked').value;
            if (startOptionSelected === 'previous') {
                const prevGPA = parseFloat(prevGPAInputElement.value);
                const prevCredits = parseFloat(prevCreditsInputElement.value);

                prevGPAInputElement.classList.remove('border-red-500');
                prevCreditsInputElement.classList.remove('border-red-500');

                if (!isNaN(prevGPA) && !isNaN(prevCredits) && prevGPA >= 0 && prevCredits >= 0) {
                    if (prevCredits == 0 && prevGPA > 0) {
                        showAppMessage('لا يمكن أن يكون المعدل التراكمي السابق أكبر من صفر إذا كانت الساعات السابقة صفر.', 'error');
                        prevGPAInputElement.classList.add('border-red-500');
                        prevCreditsInputElement.classList.add('border-red-500');
                        overallResultsSection.classList.add('hidden');
                        return;
                    }
                    overallTotalPoints += prevGPA * prevCredits;
                    overallTotalCredits += prevCredits;
                    allSemestersDataForAnalysis.push({
                        semesterName: "البيانات التراكمية السابقة",
                        semesterGPA: prevGPA.toFixed(3),
                        semesterCredits: prevCredits.toFixed(1),
                        courses: [{ name: "ملخص الساعات السابقة", credits: prevCredits, grade: `GPA: ${prevGPA.toFixed(3)}` }]
                    });
                } else if ((!isNaN(prevGPA) && isNaN(prevCredits)) || (isNaN(prevGPA) && !isNaN(prevCredits)) || prevGPA < 0 || prevCredits < 0) {
                    showAppMessage('الرجاء إدخال قيم صحيحة (أكبر من أو تساوي صفر) للمعدل التراكمي السابق والساعات السابقة أو تركهما فارغين.', 'error');
                    if (isNaN(prevGPA) || prevGPA < 0) prevGPAInputElement.classList.add('border-red-500');
                    if (isNaN(prevCredits) || prevCredits < 0) prevCreditsInputElement.classList.add('border-red-500');
                    overallResultsSection.classList.add('hidden');
                    return;
                }
            }


            const semesterBlocks = semestersContainer.querySelectorAll('.semester-block');

            if (semesterBlocks.length === 0 && startOptionSelected === 'fresh') {
                showAppMessage('الرجاء إضافة فصل دراسي حالي واحد على الأقل.', 'error');
                overallResultsSection.classList.add('hidden');
                return;
            }

            semesterBlocks.forEach(block => {
                const semesterTitleInput = block.querySelector('.semester-title-input');
                let semesterTotalPoints = 0;
                let semesterTotalCredits = 0;
                let semesterValid = true;
                const courseRows = block.querySelectorAll('.course-row');
                const semesterGPADisp = block.querySelector('.semester-gpa-display');
                const semesterCreditsDisp = block.querySelector('.semester-credits-display');

                const semesterCoursesData = [];

                if (courseRows.length === 0) {
                    semesterGPADisp.textContent = "0.000";
                    semesterCreditsDisp.textContent = "0";
                } else {
                    courseRows.forEach(row => {
                        const courseNameInput = row.querySelector('.course-name');
                        const creditsInput = row.querySelector('.course-credits');
                        const gradeSelect = row.querySelector('.course-grade');
                        const credits = parseFloat(creditsInput.value);
                        const grade = gradeSelect.value;

                        creditsInput.classList.remove('border-red-500');
                        gradeSelect.classList.remove('border-red-500');

                        if (isNaN(credits) || credits <= 0) {
                            creditsInput.classList.add('border-red-500');
                            semesterValid = false;
                        }
                        if (!grade || !gradePoints.hasOwnProperty(grade)) {
                            gradeSelect.classList.add('border-red-500');
                            semesterValid = false;
                        }

                        if (semesterValid) {
                            semesterTotalPoints += gradePoints[grade] * credits;
                            semesterTotalCredits += credits;
                            semesterCoursesData.push({
                                name: courseNameInput.value || "مادة غير مسماة",
                                credits: credits,
                                grade: grade
                            });
                        }
                    });
                }


                if (!semesterValid) {
                    allSemestersValid = false;
                    semesterGPADisp.textContent = "خطأ";
                    semesterCreditsDisp.textContent = "خطأ";
                } else if (courseRows.length > 0) {
                    const currentSemesterGPA = semesterTotalCredits > 0 ? (semesterTotalPoints / semesterTotalCredits) : 0;
                    semesterGPADisp.textContent = currentSemesterGPA.toFixed(3);
                    semesterCreditsDisp.textContent = semesterTotalCredits.toFixed(1);
                    overallTotalPoints += semesterTotalPoints;
                    overallTotalCredits += semesterTotalCredits;
                    allSemestersDataForAnalysis.push({
                        semesterName: semesterTitleInput.value || `الفصل (بدون اسم)`,
                        semesterGPA: currentSemesterGPA.toFixed(3),
                        semesterCredits: semesterTotalCredits.toFixed(1),
                        courses: semesterCoursesData
                    });
                } else {
                    semesterGPADisp.textContent = "0.000";
                    semesterCreditsDisp.textContent = "0";
                }
            });

            if (!allSemestersValid) {
                showAppMessage('الرجاء تصحيح الأخطاء في بيانات المواد (الساعات والتقديرات).', 'error');
                overallResultsSection.classList.add('hidden');
                return;
            }

            if (overallTotalCredits === 0) {
                if (semesterBlocks.length > 0 || startOptionSelected === 'previous') {
                    overallCumulativeGPADisplay.textContent = "0.000";
                    overallTotalCreditsDisplay.textContent = "0";
                    overallResultsSection.classList.remove('hidden');
                    getAnalysisBtn.classList.remove('hidden');
                    showAppMessage('تم حساب المعدل. لا توجد ساعات معتمدة مكتسبة.', 'success');
                } else {
                    showAppMessage('لا توجد بيانات لحساب المعدل.', 'error');
                    overallResultsSection.classList.add('hidden');
                }
                return;
            }


            const finalCumulativeGPA = overallTotalCredits > 0 ? (overallTotalPoints / overallTotalCredits) : 0;
            overallCumulativeGPADisplay.textContent = finalCumulativeGPA.toFixed(3);
            overallTotalCreditsDisplay.textContent = overallTotalCredits.toFixed(1);

            overallResultsSection.classList.remove('hidden');
            getAnalysisBtn.classList.remove('hidden');
            overallResultsSection.scrollIntoView({ behavior: 'smooth' });
            showAppMessage('تم حساب المعدل التراكمي الكلي بنجاح!', 'success');
        }

        async function fetchAnalysis() {
            if (overallResultsSection.classList.contains('hidden') || allSemestersDataForAnalysis.length === 0 && !(parseFloat(overallCumulativeGPADisplay.textContent) === 0 && parseFloat(overallTotalCreditsDisplay.textContent) === 0)) {
                showAppMessage('يرجى حساب المعدل التراكمي الكلي أولاً.', 'error');
                return;
            }


            analysisLoadingIndicator.classList.remove('hidden');
            analysisResultDiv.classList.add('hidden');
            analysisResultDiv.innerHTML = '';
            getAnalysisBtn.classList.add('hidden');

            let promptDetails = "تفاصيل الفصول الدراسية:\n";
            if (allSemestersDataForAnalysis.length > 0) {
                allSemestersDataForAnalysis.forEach(sem => {
                    promptDetails += `الفصل: ${sem.semesterName}\n`;
                    promptDetails += `  المعدل الفصلي: ${sem.semesterGPA}\n`;
                    promptDetails += `  الساعات المعتمدة للفصل: ${sem.semesterCredits}\n`;
                    if (sem.courses && sem.courses.length > 0 && sem.semesterName !== "البيانات التراكمية السابقة") {
                        promptDetails += `  المواد:\n`;
                        sem.courses.forEach(course => {
                            promptDetails += `    - المادة: ${course.name}, التقدير: ${course.grade}, الساعات: ${course.credits}\n`;
                        });
                    } else if (sem.semesterName === "البيانات التراكمية السابقة") {
                        promptDetails += `    - (ملخص البيانات السابقة)\n`;
                    }
                    else {
                        promptDetails += `    - لا توجد مواد مسجلة لهذا الفصل.\n`;
                    }
                    promptDetails += "\n";
                });
            } else {
                promptDetails += "لم يتم إدخال بيانات تفصيلية للفصول الدراسية.\n";
            }


            const prompt = `أنا طالب وهذا هو ملخص أدائي الأكاديمي:
المعدل التراكمي الكلي: ${overallCumulativeGPADisplay.textContent}
إجمالي الساعات المكتسبة: ${overallTotalCreditsDisplay.textContent}

${promptDetails}
يرجى تقديم تحليل شامل لأدائي الأكاديمي. يجب أن يتضمن التحليل:
1. نظرة عامة على المستوى العام للمعدل التراكمي الكلي والفصلي (إذا توفرت فصول متعددة).
2. تحديد الاتجاهات في الأداء (هل هناك تحسن، تراجع، أو استقرار عبر الفصول؟).
3. إبراز نقاط القوة والمواد أو أنواع المواد التي يظهر فيها أداء جيد.
4. تحديد مجالات التحسين والمواد التي تحتاج إلى تركيز أكبر، مع اقتراح أسباب محتملة لذلك الأداء.
5. تقديم 3-5 نصائح عملية ومخصصة بناءً على هذا التحليل لمساعدتي على تحسين أدائي في المستقبل. يجب أن تكون النصائح قابلة للتنفيذ وموجهة للطالب (مثال: استراتيجيات دراسة محددة، نصائح لإدارة الوقت، متى يجب طلب المساعدة).
قدم الرد باللغة العربية وبتنسيق واضح وسهل القراءة، استخدم نقاطًا أو قوائم مرقمة عند تقديم النصائح.`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`فشل في الاتصال بخدمة التحليل. الحالة: ${response.status}. ${errorData?.error?.message || ''}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    analysisResultDiv.textContent = analysisText;
                    analysisResultDiv.classList.remove('hidden');
                } else {
                    throw new Error('لم يتم استلام تحليل من الخدمة. قد يكون الرد فارغًا.');
                }

            } catch (error) {
                console.error('Error fetching analysis:', error);
                showAppMessage(`حدث خطأ أثناء محاولة الحصول على التحليل: ${error.message}`, 'error');
                analysisResultDiv.textContent = 'عذرًا، لم نتمكن من الحصول على التحليل في الوقت الحالي. يرجى المحاولة مرة أخرى لاحقًا.';
                analysisResultDiv.classList.remove('hidden');
            } finally {
                analysisLoadingIndicator.classList.add('hidden');
            }
        }


        addSemesterBtn.addEventListener('click', addSemester);
        calculateOverallGPABtn.addEventListener('click', calculateOverallGPA);
        getAnalysisBtn.addEventListener('click', fetchAnalysis);

        addSemester();
        getAnalysisBtn.classList.add('hidden'); 
    </script>
</body>

</html>